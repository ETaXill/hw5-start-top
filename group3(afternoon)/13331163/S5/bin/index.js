// Generated by LiveScript 1.3.1
(function(){
  var CurrentSum, addHandlerOnControlRingButtons, addHandler, addHandlerOnInfoButton, addResetFunction, reset, addRobotButton, randomSequence, showSequence, showMessage, showInfoMessage;
  $(function(){
    var currentSum;
    currentSum = new CurrentSum;
    addHandlerOnControlRingButtons(currentSum);
    addHandlerOnInfoButton(currentSum);
    addResetFunction(currentSum);
    return addRobotButton(currentSum);
  });
  CurrentSum = function(){
    this.sum = 0;
  };
  addHandlerOnControlRingButtons = function(currentSum){
    var message, reverseMessage, i$, ref$, len$, index, button;
    message = ['A:这是个天大的秘密', 'B:我不知道', 'C:你不知道', 'D:他不知道', 'E:才怪'];
    reverseMessage = ['A:这不是个天大的秘密', 'B:我知道', 'C:你知道', 'D:他知道', 'E:才不怪'];
    for (i$ = 0, len$ = (ref$ = $('.button')).length; i$ < len$; ++i$) {
      index = i$;
      button = ref$[i$];
      $(button).addClass('unvisit');
      button.status = 'unclick';
      button.message = message[index];
      button.reverseMessage = reverseMessage[index];
      addHandler(button, currentSum);
      $(button).click(fn$);
    }
    function fn$(event){
      event.stopPropagation();
      $(this).trigger('handler');
    }
  };
  addHandler = function(button, currentSum){
    $(button).bind('handler', function(event){
      var err, this$ = this;
      event.stopPropagation();
      if (this.status === 'clicked' || $(this).hasClass('visited')) {
        return;
      }
      this.status = 'clicked';
      showMessage(this, true);
      try {
        if (Math.random() > 0.4) {
          $(this).removeClass('unvisit').addClass('visited');
          throw this.reverseMessage + ";" + currentSum.sum;
        }
      } catch (e$) {
        err = e$;
        throw err;
      }
      $(this).children('.unread').addClass("visiable").text('...');
      return $.get('/', function(data, status){
        var flag, i$, ref$, len$, bt, err;
        if (this$.status === 'unclick') {
          return;
        }
        $(this$).children('.unread').text(data);
        currentSum.sum += parseInt(data);
        if (this$.status === 'clicked') {
          $(this$).removeClass('unvisit').addClass('visited');
        }
        flag = true;
        for (i$ = 0, len$ = (ref$ = $('.button')).length; i$ < len$; ++i$) {
          bt = ref$[i$];
          if ($(bt).hasClass('unvisit')) {
            flag = false;
            break;
          }
        }
        if (flag === true) {
          $('#info').removeClass('visited').addClass('unvisit').trigger('handler');
        }
        try {
          if (this$.nextButton === undefined) {
            $('#info').trigger('handler');
          } else if (this$.nextButton !== false) {
            $('li' + (":nth-child(" + this$.nextButton + ")")).trigger('handler');
          }
        } catch (e$) {
          err = e$;
          $('#message-box').text(err.split(';')[0]);
        }
      });
    });
  };
  addHandlerOnInfoButton = function(currentSum){
    var message, info;
    message = "楼主异步调用战斗力感人，目测不超过";
    info = $('#info');
    info[0].status = 'unclick';
    info[0].message = message;
    info.addClass('visited');
    info.bind('handler', function(event){
      event.stopPropagation();
      if (this.status === 'clicked' || $(this).hasClass('visited')) {
        return;
      }
      this.status = 'clicked';
      showInfoMessage(this, currentSum.sum, true);
      return $(this).removeClass('unvisit').addClass('visited').text(currentSum.sum);
    });
    info.click(function(event){
      event.stopPropagation();
      return $(this).trigger('handler');
    });
  };
  addResetFunction = function(currentSum){
    $('#button').on('mouseleave', function(){
      setTimeout(reset(currentSum, 0));
    });
  };
  reset = function(currentSum){
    var i$, ref$, len$, bt;
    for (i$ = 0, len$ = (ref$ = $('.button')).length; i$ < len$; ++i$) {
      bt = ref$[i$];
      bt.status = 'unclick';
      bt.nextButton = false;
      $(bt).removeClass('visited').addClass('unvisit');
      $(bt).children('.unread').removeClass('visiable');
    }
    $('#info').get(0).status = 'unclick';
    $('#info').removeClass('unvisit').addClass('visited').text(" ");
    currentSum.sum = 0;
    $('#button').get(0).status = "unclick";
    $('#sort').text(" ");
    $('#message-box').text(" ");
  };
  addRobotButton = function(currentSum){
    $('#button').get(0).status = 'unclick';
    $('#button').bind('handler', function(event){
      var sequence, i$, i, err;
      event.stopPropagation();
      if (this.status === 'clicked') {
        return;
      }
      reset(currentSum);
      this.status = 'clicked';
      sequence = [1, 2, 3, 4, 5];
      sequence = randomSequence(sequence);
      showSequence(sequence);
      for (i$ = 0; i$ < 4; ++i$) {
        i = i$;
        $('li' + (":nth-child(" + sequence[i] + ")")).get(0).nextButton = sequence[i + 1];
      }
      $('li' + (":nth-child(" + sequence[4] + ")")).get(0).nextButton = undefined;
      currentSum.sum = 0;
      try {
        return $('li' + (":nth-child(" + sequence[0] + ")")).trigger('handler');
      } catch (e$) {
        err = e$;
        return $('#message-box').text(err.split(';')[0]);
      }
    });
    $('#button').click(function(event){
      event.stopPropagation();
      $(this).trigger('handler');
    });
  };
  $.ajaxSetup({
    cache: false
  });
  randomSequence = function(sequence){
    sequence.sort(function(a, b){
      if (Math.random() > 0.2) {
        return 1;
      } else {
        return -1;
      }
    });
    return sequence;
  };
  showSequence = function(sequence){
    var content, i$, len$, x;
    content = new Array();
    for (i$ = 0, len$ = sequence.length; i$ < len$; ++i$) {
      x = sequence[i$];
      content.push(String.fromCharCode(x + 64));
    }
    $('#sort').text(content.join(' '));
  };
  showMessage = function(who, flag){
    if (flag === true) {
      $('#message-box').text(who.message);
    } else {
      $('#message-box').text(who.reverseMessage);
    }
  };
  showInfoMessage = function(who, sum, flag){
    if (flag === true) {
      $('#message-box').text(who.message + sum);
    } else {
      $('#message-box').text(who.reverseMessage + sum);
    }
  };
}).call(this);
